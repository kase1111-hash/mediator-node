/**
 * Vulnerability Scanner
 *
 * Automated scanning for common security vulnerabilities in the codebase.
 * Performs static analysis and pattern detection for security issues.
 */

import { randomBytes } from 'crypto';
import * as fs from 'fs';
import * as path from 'path';
import { logger } from '../utils/logger';

/**
 * Vulnerability severity levels
 */
export type VulnerabilitySeverity = 'critical' | 'high' | 'medium' | 'low' | 'info';

/**
 * Vulnerability finding
 */
export interface VulnerabilityFinding {
  id: string;
  category: string;
  severity: VulnerabilitySeverity;
  title: string;
  description: string;
  file?: string;
  line?: number;
  code?: string;
  recommendation: string;
  cweId?: string; // Common Weakness Enumeration ID
  owaspCategory?: string;
}

/**
 * Scan result
 */
export interface ScanResult {
  scanId: string;
  timestamp: number;
  duration: number;
  filesScanned: number;
  findings: VulnerabilityFinding[];
  summary: {
    critical: number;
    high: number;
    medium: number;
    low: number;
    info: number;
    total: number;
  };
  passed: boolean;
}

/**
 * Vulnerability pattern definition
 */
interface VulnerabilityPattern {
  id: string;
  category: string;
  severity: VulnerabilitySeverity;
  title: string;
  pattern: RegExp;
  description: string;
  recommendation: string;
  cweId?: string;
  owaspCategory?: string;
  excludePatterns?: RegExp[];
}

/**
 * VulnerabilityScanner performs automated security scanning
 */
export class VulnerabilityScanner {
  private patterns: VulnerabilityPattern[];
  private excludeDirs: string[];
  private excludeFiles: RegExp[];

  constructor() {
    this.patterns = this.initializePatterns();
    this.excludeDirs = ['node_modules', 'dist', 'coverage', '.git', 'vector-db'];
    this.excludeFiles = [/\.test\.ts$/, /\.spec\.ts$/, /\.d\.ts$/];
  }

  /**
   * Initialize vulnerability detection patterns
   */
  private initializePatterns(): VulnerabilityPattern[] {
    return [
      // Command Injection
      {
        id: 'CMD-001',
        category: 'Command Injection',
        severity: 'critical',
        title: 'Potential Command Injection via eval()',
        pattern: /\beval\s*\(/g,
        description: 'Use of eval() can lead to arbitrary code execution',
        recommendation: 'Replace eval() with safer alternatives like JSON.parse() or explicit function calls',
        cweId: 'CWE-94',
        owaspCategory: 'A03:2021-Injection',
      },
      {
        id: 'CMD-002',
        category: 'Command Injection',
        severity: 'critical',
        title: 'Potential Command Injection via new Function()',
        pattern: /new\s+Function\s*\(/g,
        description: 'Dynamic function creation can lead to code injection',
        recommendation: 'Use explicit function definitions instead of dynamic creation',
        cweId: 'CWE-94',
        owaspCategory: 'A03:2021-Injection',
      },
      {
        id: 'CMD-003',
        category: 'Command Injection',
        severity: 'critical',
        title: 'Potential Shell Command Execution',
        pattern: /\b(exec|execSync|spawn|spawnSync)\s*\(/g,
        description: 'Shell command execution with user input can lead to command injection',
        recommendation: 'Validate and sanitize all inputs before shell execution, use parameterized commands',
        cweId: 'CWE-78',
        owaspCategory: 'A03:2021-Injection',
        excludePatterns: [/child_process/],
      },

      // SQL Injection (if applicable)
      {
        id: 'SQL-001',
        category: 'SQL Injection',
        severity: 'critical',
        title: 'Potential SQL Injection',
        pattern: /\$\{[^}]+\}.*(?:SELECT|INSERT|UPDATE|DELETE|FROM|WHERE)/gi,
        description: 'String interpolation in SQL queries can lead to SQL injection',
        recommendation: 'Use parameterized queries or prepared statements',
        cweId: 'CWE-89',
        owaspCategory: 'A03:2021-Injection',
      },

      // Path Traversal
      {
        id: 'PATH-001',
        category: 'Path Traversal',
        severity: 'high',
        title: 'Potential Path Traversal',
        pattern: /\.\.\//g,
        description: 'Path traversal sequences can allow access to unauthorized files',
        recommendation: 'Use path.resolve() and validate paths against a base directory',
        cweId: 'CWE-22',
        owaspCategory: 'A01:2021-Broken Access Control',
        excludePatterns: [/import|require|from\s+['"]/],
      },

      // Sensitive Data Exposure
      {
        id: 'DATA-001',
        category: 'Sensitive Data',
        severity: 'high',
        title: 'Hardcoded Credentials',
        pattern: /(?:password|secret|api_key|apikey|auth_token|private_key)\s*[:=]\s*['"][^'"]+['"]/gi,
        description: 'Hardcoded credentials can lead to credential theft',
        recommendation: 'Use environment variables or secure secret management',
        cweId: 'CWE-798',
        owaspCategory: 'A02:2021-Cryptographic Failures',
        excludePatterns: [/test|mock|example|sample|placeholder/i],
      },
      {
        id: 'DATA-002',
        category: 'Sensitive Data',
        severity: 'medium',
        title: 'Potential Sensitive Data Logging',
        pattern: /console\.(log|info|warn|error)\s*\([^)]*(?:password|secret|token|key|credential)/gi,
        description: 'Logging sensitive data can expose credentials in log files',
        recommendation: 'Redact sensitive information before logging',
        cweId: 'CWE-532',
        owaspCategory: 'A09:2021-Security Logging and Monitoring Failures',
      },

      // Cryptographic Issues
      {
        id: 'CRYPTO-001',
        category: 'Weak Cryptography',
        severity: 'high',
        title: 'Weak Hashing Algorithm (MD5)',
        pattern: /\bmd5\b/gi,
        description: 'MD5 is cryptographically broken and should not be used for security purposes',
        recommendation: 'Use SHA-256 or stronger hashing algorithms',
        cweId: 'CWE-328',
        owaspCategory: 'A02:2021-Cryptographic Failures',
      },
      {
        id: 'CRYPTO-002',
        category: 'Weak Cryptography',
        severity: 'high',
        title: 'Weak Hashing Algorithm (SHA1)',
        pattern: /\bsha1\b/gi,
        description: 'SHA-1 is deprecated for cryptographic purposes',
        recommendation: 'Use SHA-256 or stronger hashing algorithms',
        cweId: 'CWE-328',
        owaspCategory: 'A02:2021-Cryptographic Failures',
      },
      {
        id: 'CRYPTO-003',
        category: 'Weak Cryptography',
        severity: 'high',
        title: 'Weak Encryption (DES)',
        pattern: /\bdes\b/gi,
        description: 'DES is a weak encryption algorithm',
        recommendation: 'Use AES-256 or stronger encryption',
        cweId: 'CWE-327',
        owaspCategory: 'A02:2021-Cryptographic Failures',
      },

      // Prototype Pollution
      {
        id: 'PROTO-001',
        category: 'Prototype Pollution',
        severity: 'high',
        title: 'Potential Prototype Pollution',
        pattern: /__proto__/g,
        description: 'Direct access to __proto__ can lead to prototype pollution',
        recommendation: 'Use Object.create(null) or validate property names',
        cweId: 'CWE-1321',
        owaspCategory: 'A03:2021-Injection',
      },
      {
        id: 'PROTO-002',
        category: 'Prototype Pollution',
        severity: 'medium',
        title: 'Potential Prototype Pollution via constructor',
        pattern: /\[['"]constructor['"]\]/g,
        description: 'Dynamic property access to constructor can enable prototype pollution',
        recommendation: 'Validate property names before dynamic access',
        cweId: 'CWE-1321',
        owaspCategory: 'A03:2021-Injection',
      },

      // XSS (if applicable for any frontend)
      {
        id: 'XSS-001',
        category: 'Cross-Site Scripting',
        severity: 'high',
        title: 'Potential XSS via innerHTML',
        pattern: /\.innerHTML\s*=/g,
        description: 'Setting innerHTML with user input can lead to XSS',
        recommendation: 'Use textContent or sanitize HTML before insertion',
        cweId: 'CWE-79',
        owaspCategory: 'A03:2021-Injection',
      },

      // Insecure Randomness
      {
        id: 'RAND-001',
        category: 'Insecure Randomness',
        severity: 'medium',
        title: 'Insecure Random Number Generation',
        pattern: /Math\.random\s*\(\)/g,
        description: 'Math.random() is not cryptographically secure',
        recommendation: 'Use crypto.randomBytes() or crypto.randomUUID() for security-sensitive operations',
        cweId: 'CWE-330',
        owaspCategory: 'A02:2021-Cryptographic Failures',
        excludePatterns: [/test|mock|example/i],
      },

      // Denial of Service
      {
        id: 'DOS-001',
        category: 'Denial of Service',
        severity: 'medium',
        title: 'Potential ReDoS Pattern',
        pattern: /new\s+RegExp\s*\([^)]*\+/g,
        description: 'Dynamic regex with user input can lead to ReDoS',
        recommendation: 'Validate regex patterns and use timeout protection',
        cweId: 'CWE-1333',
        owaspCategory: 'A05:2021-Security Misconfiguration',
      },

      // Unsafe Deserialization
      {
        id: 'DESER-001',
        category: 'Insecure Deserialization',
        severity: 'medium',
        title: 'Unsafe JSON.parse without validation',
        pattern: /JSON\.parse\s*\([^)]+\)(?!\s*as\s+|\s*:\s*)/g,
        description: 'JSON.parse without type validation can lead to type confusion',
        recommendation: 'Validate parsed JSON against a schema using Zod or similar',
        cweId: 'CWE-502',
        owaspCategory: 'A08:2021-Software and Data Integrity Failures',
        excludePatterns: [/try\s*\{/, /catch/],
      },

      // HTTP Security
      {
        id: 'HTTP-001',
        category: 'Insecure Transport',
        severity: 'medium',
        title: 'Hardcoded HTTP URL',
        pattern: /['"]http:\/\/(?!localhost|127\.0\.0\.1)[^'"]+['"]/g,
        description: 'Using HTTP instead of HTTPS exposes data in transit',
        recommendation: 'Use HTTPS for all external communications',
        cweId: 'CWE-319',
        owaspCategory: 'A02:2021-Cryptographic Failures',
      },

      // Error Handling
      {
        id: 'ERR-001',
        category: 'Information Disclosure',
        severity: 'low',
        title: 'Empty Catch Block',
        pattern: /catch\s*\([^)]*\)\s*\{\s*\}/g,
        description: 'Empty catch blocks may hide errors and security issues',
        recommendation: 'Log errors or handle them appropriately',
        cweId: 'CWE-390',
        owaspCategory: 'A09:2021-Security Logging and Monitoring Failures',
      },
    ];
  }

  /**
   * Scan a directory for vulnerabilities
   */
  public async scanDirectory(dirPath: string): Promise<ScanResult> {
    const startTime = Date.now();
    const scanId = `scan-${Date.now()}-${randomBytes(6).toString('hex')}`;
    const findings: VulnerabilityFinding[] = [];
    let filesScanned = 0;

    logger.info('Starting vulnerability scan', { dirPath, scanId });

    const files = this.getFilesRecursive(dirPath);

    for (const file of files) {
      filesScanned++;
      const fileFindings = await this.scanFile(file);
      findings.push(...fileFindings);
    }

    const summary = this.summarizeFindings(findings);
    const duration = Date.now() - startTime;

    const result: ScanResult = {
      scanId,
      timestamp: Date.now(),
      duration,
      filesScanned,
      findings,
      summary,
      passed: summary.critical === 0 && summary.high === 0,
    };

    logger.info('Vulnerability scan complete', {
      scanId,
      filesScanned,
      findings: summary.total,
      passed: result.passed,
      duration: `${duration}ms`,
    });

    return result;
  }

  /**
   * Scan a single file for vulnerabilities
   */
  public async scanFile(filePath: string): Promise<VulnerabilityFinding[]> {
    const findings: VulnerabilityFinding[] = [];

    try {
      const content = fs.readFileSync(filePath, 'utf-8');
      const lines = content.split('\n');

      for (const pattern of this.patterns) {
        const matches = content.matchAll(pattern.pattern);

        for (const match of matches) {
          // Check if match should be excluded
          if (pattern.excludePatterns) {
            const context = this.getContext(content, match.index || 0);
            const shouldExclude = pattern.excludePatterns.some((ep) => ep.test(context));
            if (shouldExclude) continue;
          }

          const lineNumber = this.getLineNumber(content, match.index || 0);
          const lineContent = lines[lineNumber - 1] || '';

          findings.push({
            id: `${pattern.id}-${match.index}`,
            category: pattern.category,
            severity: pattern.severity,
            title: pattern.title,
            description: pattern.description,
            file: filePath,
            line: lineNumber,
            code: lineContent.trim().substring(0, 100),
            recommendation: pattern.recommendation,
            cweId: pattern.cweId,
            owaspCategory: pattern.owaspCategory,
          });
        }
      }
    } catch (error) {
      logger.warn('Failed to scan file', { filePath, error });
    }

    return findings;
  }

  /**
   * Get surrounding context for a match
   */
  private getContext(content: string, index: number, contextSize: number = 100): string {
    const start = Math.max(0, index - contextSize);
    const end = Math.min(content.length, index + contextSize);
    return content.substring(start, end);
  }

  /**
   * Get line number for a character index
   */
  private getLineNumber(content: string, index: number): number {
    return content.substring(0, index).split('\n').length;
  }

  /**
   * Get all TypeScript files recursively
   */
  private getFilesRecursive(dirPath: string): string[] {
    const files: string[] = [];

    if (!fs.existsSync(dirPath)) {
      return files;
    }

    const entries = fs.readdirSync(dirPath, { withFileTypes: true });

    for (const entry of entries) {
      const fullPath = path.join(dirPath, entry.name);

      if (entry.isDirectory()) {
        if (!this.excludeDirs.includes(entry.name)) {
          files.push(...this.getFilesRecursive(fullPath));
        }
      } else if (entry.isFile()) {
        if (fullPath.endsWith('.ts') && !this.excludeFiles.some((p) => p.test(fullPath))) {
          files.push(fullPath);
        }
      }
    }

    return files;
  }

  /**
   * Summarize findings by severity
   */
  private summarizeFindings(findings: VulnerabilityFinding[]): ScanResult['summary'] {
    return {
      critical: findings.filter((f) => f.severity === 'critical').length,
      high: findings.filter((f) => f.severity === 'high').length,
      medium: findings.filter((f) => f.severity === 'medium').length,
      low: findings.filter((f) => f.severity === 'low').length,
      info: findings.filter((f) => f.severity === 'info').length,
      total: findings.length,
    };
  }

  /**
   * Get patterns for testing
   */
  public getPatterns(): VulnerabilityPattern[] {
    return [...this.patterns];
  }

  /**
   * Add custom pattern
   */
  public addPattern(pattern: VulnerabilityPattern): void {
    this.patterns.push(pattern);
  }
}
